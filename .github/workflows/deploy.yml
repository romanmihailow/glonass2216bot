name: Deploy to Remote Server

# –¢—Ä–∏–≥–≥–µ—Ä –Ω–∞ –ø—É—à –≤ –≤–µ—Ç–∫—É task_github_deploy
on:
  push:
    branches:
      - task_github_deploy

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: Checkout repository
        uses: actions/checkout@v3

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É
      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.8.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã –∫–ª—é—á–∞ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
      - name: Check SSH_PRIVATE_KEY
        run: |
          echo "Secret length: ${#SSH_PRIVATE_KEY}"
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      # –î–µ–ø–ª–æ–π –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
      - name: Deploy to remote server
        run: |
          ssh -o StrictHostKeyChecking=no root@193.168.48.226 << 'EOF'
            cd ~/glonass2216bot

            echo "üõë Stopping existing container..."
            docker-compose down

            echo "üõ† Building new image..."
            docker-compose build --no-cache

            echo "üöÄ Starting new container..."
            docker-compose up -d

            echo "‚úÖ Deploy complete!"
          EOF
